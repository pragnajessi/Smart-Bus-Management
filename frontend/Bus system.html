<!DOCTYPE html>
<html>

<head>
    <title>Smart Bus Live Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        body {
            margin: 0;
        }

        #map {
            height: 100vh;
        }
    </style>
</head>

<body>

    <div id="map"></div>

    <script>
        const channel = new BroadcastChannel("bus_channel");

        /* ===== BUS STOPS ===== */
        const stops = {
            "Miyapur": [16.5062, 80.6480],
            "Koti": [16.5166, 80.6160],
            "LB Nagar": [16.5450, 80.6100],
            "Hayathnagar": [16.5620, 80.6050],
            "Nalgonda": [16.5800, 80.5950],
            "Suryapet": [16.6100, 80.5800],
            "Nandigama": [16.6300, 80.5600],
            "Ibrahimpatnam": [16.6500, 80.5400],
            "Bhavanipuram": [16.6700, 80.5200],
            "PNBS": [16.6900, 80.5000],
            "Benz Circle": [16.7100, 80.4800],
            "Ramavarappadu Ring": [16.7300, 80.4600],
            "Vijayawada": [16.7500, 80.4400]
        };

        /* ===== MAP SETUP ===== */
        const map = L.map("map").setView(stops["Miyapur"], 12);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

        /* ===== ICONS ===== */
        const busIcon = L.icon({
            iconUrl: "https://cdn-icons-png.flaticon.com/512/61/61231.png",
            iconSize: [45, 45]
        });

        const stopIcon = L.icon({
            iconUrl: "https://cdn-icons-png.flaticon.com/512/684/684908.png",
            iconSize: [28, 28]
        });

        const emergencyIcon = L.icon({
            iconUrl: "https://cdn-icons-png.flaticon.com/512/564/564619.png",
            iconSize: [40, 40]
        });

        /* ===== DRAW STOPS ON MAP ===== */
        Object.entries(stops).forEach(([name, coords]) => {
            L.marker(coords, { icon: stopIcon })
                .addTo(map)
                .bindPopup(name);
        });

        /* ===== BUS MARKER ===== */
        let bus = L.marker(stops["Miyapur"], { icon: busIcon }).addTo(map);

        /* ===== HELPERS ===== */
        function distance(lat1, lng1, lat2, lng2) {
            return Math.sqrt((lat1 - lat2) ** 2 + (lng1 - lng2) ** 2) * 111;
        }

        let announced = {};

        /* ===== RECEIVE GPS & EMERGENCY ===== */
        channel.onmessage = e => {
            const data = e.data;

            /* GPS UPDATE */
            if (data.type === "gps") {
                bus.setLatLng([data.lat, data.lng]);
                map.panTo([data.lat, data.lng]);

                for (let stop in stops) {
                    const [slat, slng] = stops[stop];
                    const d = distance(data.lat, data.lng, slat, slng);

                    const speed = 35; // km/h
                    const eta = (d / speed) * 60;

                    channel.postMessage({
                        type: "eta",
                        stop,
                        minutes: eta.toFixed(1)
                    });

                    if (eta <= 2 && !announced[stop]) {
                        announced[stop] = "near";
                        channel.postMessage({ type: "announce", stop, stage: "near" });
                    }

                    if (d < 0.2 && announced[stop] === "near") {
                        announced[stop] = "arrived";
                        channel.postMessage({ type: "announce", stop, stage: "arrived" });
                    }
                }
            }

            /* EMERGENCY */
            if (data.type === "emergency") {
                L.marker([data.lat, data.lng], { icon: emergencyIcon })
                    .addTo(map)
                    .bindPopup("ðŸš¨ Emergency Alert")
                    .openPopup();
            }
        };
    </script>

</body>

</html>