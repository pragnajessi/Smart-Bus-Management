<!DOCTYPE html>
<html>

<head>
    <title>Smart Bus Live Tracking</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        body {
            margin: 0
        }

        #map {
            height: 100vh
        }
    </style>
</head>

<body>
    <div id="map"></div>

    <script>
        const channel = new BroadcastChannel("bus_channel");

        const stops = {
            "Miyapur": [16.5062, 80.6480],
            "Koti": [16.5166, 80.6160],
            "LB Nagar": [16.5450, 80.6100],
            "Hayathnagar": [16.5620, 80.6050],
            "Nalgonda": [16.5800, 80.5950],
            "Suryapet": [16.6100, 80.5800],
            "Nandigama": [16.6300, 80.5600],
            "Ibrahimpatnam": [16.6500, 80.5400],
            "Bhavanipuram": [16.6700, 80.5200],
            "PNBS": [16.6900, 80.5000],
            "Benz Circle": [16.7100, 80.4800],
            "Ramavarappadu Ring": [16.7300, 80.4600],
            "Vijayawada": [16.7500, 80.4400]
        };

        const map = L.map('map').setView([16.5062, 80.6480], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        const busIcon = L.icon({
            iconUrl: "https://cdn-icons-png.flaticon.com/512/61/61231.png",
            iconSize: [45, 45]
        });

        const emergencyIcon = L.icon({
            iconUrl: "https://cdn-icons-png.flaticon.com/512/564/564619.png",
            iconSize: [40, 40]
        });

        let bus = L.marker([16.5062, 80.6480], { icon: busIcon }).addTo(map);
        let announced = {};

        function speak(text) {
            speechSynthesis.speak(new SpeechSynthesisUtterance(text));
        }

        function distance(a, b, c, d) {
            return Math.sqrt((a - c) ** 2 + (b - d) ** 2) * 111;
        }

        channel.onmessage = e => {
            const data = e.data;

            if (data.type === "gps") {
                bus.setLatLng([data.lat, data.lng]);
                map.panTo([data.lat, data.lng]);

                for (let stop in stops) {
                    let [slat, slng] = stops[stop];
                    let d = distance(data.lat, data.lng, slat, slng);

                    if (d < 1.3 && !announced[stop]) {
                        speak("Attention passengers, next stop is " + stop);
                        channel.postMessage({ type: "announce", stop: stop, stage: "near" });
                        announced[stop] = "near";
                    }

                    if (d < 0.2 && announced[stop] !== "arrived") {
                        speak("Bus has arrived at " + stop);
                        channel.postMessage({ type: "announce", stop: stop, stage: "arrived" });
                        announced[stop] = "arrived";
                    }
                }
            }

            if (data.type === "emergency") {
                L.marker([data.lat, data.lng], { icon: emergencyIcon })
                    .addTo(map)
                    .bindPopup("ðŸš¨ Emergency Alert!")
                    .openPopup();

                speak("Emergency reported in the bus. Immediate help required.");
            }
        };
    </script>
</body>

</html>